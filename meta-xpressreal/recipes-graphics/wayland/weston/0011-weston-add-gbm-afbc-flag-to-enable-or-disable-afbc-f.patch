From 23361df21832551a08a28b6c5e3e8341a075d28b Mon Sep 17 00:00:00 2001
From: yaozenhu <yaozenhu@realtek.com>
Date: Mon, 25 Nov 2024 17:56:35 +0800
Subject: [PATCH] weston: add gbm-afbc flag to enable or disable afbc feature

Upstream-Status: Inappropriate [rtk specific]
---
 compositor/main.c               |  1 +
 include/libweston/libweston.h   |  1 +
 libweston/backend-drm/drm-gbm.c | 23 ++++++++++++++++++-----
 3 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/compositor/main.c b/compositor/main.c
index e134817..5bd8bfe 100644
--- a/compositor/main.c
+++ b/compositor/main.c
@@ -3080,6 +3080,7 @@ load_drm_backend(struct weston_compositor *c, int *argc, char **argv,
 
 	weston_config_section_get_bool(section, "dmabuf-v1-overlay", &c->dmabuf_v1_overlay, false);
 	weston_config_section_get_bool(section, "transparent-fade-layer", &c->transparent_fade_layer, false);
+	weston_config_section_get_bool(section, "gbm-afbc", &c->gbm_afbc, false);
 
 	if (without_input)
 		c->require_input = !without_input;
diff --git a/include/libweston/libweston.h b/include/libweston/libweston.h
index 350d23d..cc9c457 100644
--- a/include/libweston/libweston.h
+++ b/include/libweston/libweston.h
@@ -1521,6 +1521,7 @@ struct weston_compositor {
 
 	bool dmabuf_v1_overlay;
 	bool transparent_fade_layer;
+	bool gbm_afbc;
 	bool found_drm_fd;
 };
 
diff --git a/libweston/backend-drm/drm-gbm.c b/libweston/backend-drm/drm-gbm.c
index 6295c8e..580a87f 100644
--- a/libweston/backend-drm/drm-gbm.c
+++ b/libweston/backend-drm/drm-gbm.c
@@ -187,6 +187,9 @@ create_gbm_surface(struct gbm_device *gbm, struct drm_output *output)
 	struct weston_drm_format *fmt;
 	const uint64_t *modifiers;
 	unsigned int num_modifiers;
+	struct drm_backend *b = output->backend;
+	unsigned int linear_num_modifiers = 1;
+	const uint64_t linear_modifiers = DRM_FORMAT_MOD_LINEAR;
 
 	fmt = weston_drm_format_array_find_format(&plane->formats,
 						  output->format->format);
@@ -199,11 +202,21 @@ create_gbm_surface(struct gbm_device *gbm, struct drm_output *output)
 
 	if (!weston_drm_format_has_modifier(fmt, DRM_FORMAT_MOD_INVALID)) {
 		modifiers = weston_drm_format_get_modifiers(fmt, &num_modifiers);
-		output->gbm_surface =
-			gbm_surface_create_with_modifiers(gbm,
-							  mode->width, mode->height,
-							  output->format->format,
-							  modifiers, num_modifiers);
+		if (b->compositor->gbm_afbc == true) {
+			printf("choose best modifier support\n");
+			output->gbm_surface =
+				gbm_surface_create_with_modifiers(gbm,
+								  mode->width, mode->height,
+								  output->format->format,
+								  modifiers, num_modifiers);
+		} else {
+			printf("force linear mode support\n");
+			output->gbm_surface =
+				gbm_surface_create_with_modifiers(gbm,
+						mode->width, mode->height,
+						output->format->format,
+						&linear_modifiers, linear_num_modifiers);
+		}
 	}
 
 	/*
-- 
2.34.1


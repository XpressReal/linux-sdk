From fe78d76af26119806a8c8d31b24342303d9e3c02 Mon Sep 17 00:00:00 2001
From: yaozenhu <yaozenhu@realtek.com>
Date: Tue, 8 Oct 2024 11:35:27 +0800
Subject: [PATCH] support sw cursor config

Upstream-Status: Inappropriate [rtk specific]
---
 compositor/main.c               | 4 ++++
 include/libweston/backend-drm.h | 3 +++
 libweston/backend-drm/drm.c     | 2 ++
 3 files changed, 9 insertions(+)

diff --git a/compositor/main.c b/compositor/main.c
index 0e3d375..e67a0e8 100644
--- a/compositor/main.c
+++ b/compositor/main.c
@@ -3061,6 +3061,10 @@ load_drm_backend(struct weston_compositor *c, int *argc, char **argv,
 	                               &config.pageflip_timeout, 0);
 	weston_config_section_get_bool(section, "pixman-shadow",
 				       &config.use_pixman_shadow, true);
+
+	weston_config_section_get_bool(section, "sw-cursor",
+					   &config.use_sw_cursor, false);
+
 	if (without_input)
 		c->require_input = !without_input;
 
diff --git a/include/libweston/backend-drm.h b/include/libweston/backend-drm.h
index d47955c..0d1f364 100644
--- a/include/libweston/backend-drm.h
+++ b/include/libweston/backend-drm.h
@@ -251,6 +251,9 @@ struct weston_drm_backend_config {
 	/** Use shadow buffer if using Pixman-renderer. */
 	bool use_pixman_shadow;
 
+	/** Enable sw cursor. */
+	bool use_sw_cursor;
+
 	/** Additional DRM devices to open
 	 *
 	 * A comma-separated list of DRM devices names, like "card1", to open.
diff --git a/libweston/backend-drm/drm.c b/libweston/backend-drm/drm.c
index b46ed63..3a03f4c 100644
--- a/libweston/backend-drm/drm.c
+++ b/libweston/backend-drm/drm.c
@@ -4022,6 +4022,8 @@ drm_backend_create(struct weston_compositor *compositor,
 
 	/* A this point we have some idea of whether or not we have a working
 	 * cursor plane. */
+	device->cursors_are_broken |= config->use_sw_cursor;
+
 	if (!device->cursors_are_broken)
 		compositor->capabilities |= WESTON_CAP_CURSOR_PLANE;
 
-- 
2.34.1


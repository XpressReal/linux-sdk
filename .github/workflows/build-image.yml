name: Build images

on:
  workflow_dispatch:

  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: [self-hosted, Linux]

    steps:
      - name: Install Yocto Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y file gawk wget git diffstat unzip texinfo gcc build-essential chrpath socat cpio libacl1 locales python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping python3-git python3-jinja2 libsdl1.2-dev python3-subunit zstd liblz4-tool

      - name: Config git ident name
        run: |
          git config --global user.name "XpressReal SDK Builder"
          git config --global user.email "builder@example.com"

      - name: 1. Checkout Poky from Yocto Project
        if: ${{ hashFiles('poky/LICENSE') == '' }}
        run: |
          echo "--- Cloning poky ---"
          git clone -b scarthgap https://git.yoctoproject.org/poky

      - name: 2. Checkout linux-sdk repo and move meta-xpressreal
        if: ${{ hashFiles('poky/meta-xpressreal/EULA.txt') == '' }}
        uses: actions/checkout@v4
        with:
          path: linux-sdk-temp
          
      - name: Move meta-xpressreal
        if: ${{ hashFiles('poky/meta-xpressreal/EULA.txt') == '' }}
        run: mv linux-sdk-temp/meta-xpressreal poky/

      - name: 3. Download prebuilt rootfs
        if: ${{ hashFiles('poky/meta-xpressreal/recipes-xpressreal/prebuilt-rootfs/files/debian-rootfs.tar.xz') == '' }}
        run: |
          echo "--- Download prebuilt rootfs ---"
          export ROOTFS_DL_URL="https://github.com/XpressReal/linux-sdk/releases/download/prebuilt-rootfs"
          export OUTPUT_DIR="./poky/meta-xpressreal/recipes-xpressreal/prebuilt-rootfs/files"
          for d in debian ubuntu; do for v in "" "weston-" "desktop-"; do echo "Downloading ${v}${d}-rootfs.tar.xz"; wget -q -O ${OUTPUT_DIR}/${v}${d}-rootfs.tar.xz ${ROOTFS_DL_URL}/${v}${d}-rootfs.tar.xz; done; done

      - name: 4. Clone Dependency Layers into poky/
        if: ${{ hashFiles('poky/LICENSE') == '' }}
        working-directory: ./poky
        run: |
          echo "--- Cloning meta-openembedded ---"
          git clone -b scarthgap git://git.openembedded.org/meta-openembedded

          echo "--- Cloning meta-qt5 ---"
          git clone -b scarthgap https://github.com/meta-qt5/meta-qt5.git

          echo "--- Cloning meta-neural-network ---"
          git clone -b scarthgap https://github.com/nnstreamer/meta-neural-network.git

      - name: 5. Lock All Repos to Specific Commits
        if: ${{ hashFiles('poky/LICENSE') == '' }}
        working-directory: ./poky
        run: |
          echo "--- Locking Poky to specific commit ---"
          git checkout dabe9e157f

          echo "--- Locking dependency layers to specific commits ---"
          cd meta-openembedded && git checkout 2338409efc && cd ..
          cd meta-qt5 && git checkout eb82841826 && cd ..
          cd meta-neural-network && git checkout c14458c94e && cd ..

          echo "--- Final directory structure inside poky: ---"
          ls -l

      - name: Initialize Build Environment using TEMPLATECONF
        if: ${{ hashFiles('poky/build/conf/local.conf') == '' }}
        working-directory: ./poky
        run: |
          TEMPLATECONF=meta-xpressreal/conf/templates/default/ source oe-init-build-env build
          echo "--- Generated bblayers.conf ---"
          cat conf/bblayers.conf
          echo "--- Generated local.conf ---"
          cat conf/local.conf

      - name: Cache Yocto Downloads and SSTATE
        uses: actions/cache@v4
        with:
          path: |
            poky/build/downloads
            poky/build/sstate-cache
          key: ${{ runner.os }}-yocto-scarthgap-${{ hashFiles('poky/build/conf/local.conf', 'poky/build/conf/bblayers.conf') }}
          restore-keys: |
            ${{ runner.os }}-yocto-scarthgap-

      - name: Run BitBake Build (core-image-minimal)
        if: ${{ hashFiles('poky/build/images/xpressreal-core-image-minimal.wic.xz') == '' }}
        working-directory: ./poky
        run: |
          source oe-init-build-env build
          bitbake core-image-minimal
          mkdir images
          cp ./tmp/deploy/images/bleedingedge-rtd1619b/core-image-minimal-*.rootfs.wic.xz ./images/xpressreal-core-image-minimal.wic.xz

      - name: Run BitBake Build (debian image server)
        if: ${{ hashFiles('poky/build/images/xpressreal-debian-image-server.wic.xz') == '' }}
        working-directory: ./poky
        run: |
          source oe-init-build-env build
          bitbake debian-image
          cp ./tmp/deploy/images/bleedingedge-rtd1619b/debian-image-*.rootfs.wic.xz ./images/xpressreal-debian-image-server.wic.xz

      - name: Run BitBake Build (ubuntu image server)
        if: ${{ hashFiles('poky/build/images/xpressreal-ubuntu-image-server.wic.xz') == '' }}
        working-directory: ./poky
        run: |
          source oe-init-build-env build
          echo 'OVERRIDES:append = ":ubuntu"' > temp-config.conf
          bitbake --postread=temp-config.conf debian-image
          cp ./tmp/deploy/images/bleedingedge-rtd1619b/debian-image-*.rootfs.wic.xz ./images/xpressreal-ubuntu-image-server.wic.xz

      - name: Run BitBake Build (debian image desktop)
        if: ${{ hashFiles('poky/build/images/xpressreal-debian-image-desktop.wic.xz') == '' }}
        working-directory: ./poky
        run: |
          source oe-init-build-env build
          echo 'MACHINE_FEATURES:append = " panfrost hifi xdesktop"' > temp-config.conf
          bitbake --postread=temp-config.conf debian-image
          cp ./tmp/deploy/images/bleedingedge-rtd1619b/debian-image-*.rootfs.wic.xz ./images/xpressreal-debian-image-desktop.wic.xz

      - name: Run BitBake Build (ubuntu image desktop)
        if: ${{ hashFiles('poky/build/images/xpressreal-ubuntu-image-desktop.wic.xz') == '' }}
        working-directory: ./poky
        run: |
          source oe-init-build-env build
          echo 'MACHINE_FEATURES:append = " panfrost hifi xdesktop"' > temp-config.conf
          echo 'OVERRIDES:append = ":ubuntu"' >> temp-config.conf
          bitbake --postread=temp-config.conf debian-image
          cp ./tmp/deploy/images/bleedingedge-rtd1619b/debian-image-*.rootfs.wic.xz ./images/xpressreal-ubuntu-image-desktop.wic.xz

      - name: Create Release and Upload Artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            poky/build/images/xpressreal-core-image-minimal.wic.xz
            poky/build/images/xpressreal-debian-image-server.wic.xz
            poky/build/images/xpressreal-ubuntu-image-server.wic.xz
            poky/build/images/xpressreal-debian-image-desktop.wic.xz
            poky/build/images/xpressreal-ubuntu-image-desktop.wic.xz
